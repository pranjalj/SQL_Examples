SELECT tb4.dept_name, tb3.above_avg_pect FROM departments tb4 INNER JOIN (SELECT tb2.dept_no, ((COUNT(tb1.salary)*100)/total) as above_avg_pect FROM (SELECT cd.dept_no as dept_no, s.salary as salary FROM salaries as s INNER JOIN current_dept_emp as cd ON cd.emp_no = s.emp_no WHERE YEAR(s.to_date) = 9999) as tb1 INNER JOIN (SELECT cd.dept_no as dept_no, AVG(s.salary) as average, COUNT(s.salary) as total FROM salaries as s INNER JOIN current_dept_emp as cd ON cd.emp_no = s.emp_no WHERE YEAR(s.to_date) = 9999 GROUP BY cd.dept_no) as tb2 ON tb1.dept_no = tb2.dept_no WHERE tb2.average < tb1.salary GROUP BY tb2.dept_no) as tb3 ON tb4.dept_no = tb3.dept_no ORDER BY tb4.dept_name;
